ARM Cortex-M处理器：32位寄存器、32位内部数据通路、32位总线接口，

M3和M4：三级流水线（取指、译码、执行），哈佛总线结构，取指和数据访问可以同时执行

​					  指令集为Thumb，通过Thumb-2技术，允许16位和32位指令混合使用

**两种操作状态**：调试状态--当处理器被暂停后，便会进入调试状态，并停止指令执行；

​							  Thumb状态--处理器执行程序指令（Thumb指令）时就处于Thumb状态

**两种操作模式**：处理模式--执行中断服务程序（ISR）等异常处理

​							  线程模式--执行普通应用程序代码是，处理器可处于特权访问或非特权访问模式，有特殊寄存器CONTROL控制

#### **寄存器**：

​				  R0~R12--通用目的寄存器，初始值未定义，前8个为低寄存器，许多16位指令只能访问低寄存器，高寄存器则可用于32位和几个16位指令

​				R13--栈指针（SP），通过PUSH和POP操作实现栈存储的访问，物理上存在两个栈指针，默认为主栈指针（MSP)，进程栈				指针（PSP)只能用于线程模式。

​				R14--链接寄存器（LR）， 用于函数或子程序调用时返回地址的保存

​				R15--程序计数器（PC），可读可写，读则返回当前指令地址加4，写则引起跳转操作

#### **特殊寄存器**：

​				程序状态寄存器（xPSR）--x=A， 应用PSR, x=E, 执行PSR；x=I, 中断PSR。

​				PRIMASK(可以禁止除HardFault和NMI外的所有异常) 、 FALULTMASK、BASEPRI寄存器，用于异常或中断

​				CONTROL寄存器--定义了栈指针的选择（主栈指针/进程栈指针）以及线程模式的访问等级（特权/非特权）

#### 存储器系统:

​				4GB线性地址空间；架构定义的存储器映射；支持大端和小端的存储器系统；位段访问；写缓存；存储器保护单元(MPU)；非对齐传输文件;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

​				存储器映射：分区--程序代码访问、数据访问、外设、处理器的内部控制和调试部件。

​				栈存储：将系统主存用于栈空间操作，满递减模型，初始化为空间的最后位置；主栈指针（MSP)--复位默认使用，用于所有的异常处理；进程栈指针(PSP)--只能用于线程模式，通常用于运行嵌入式OS中的应用程序

​				存储器保护单元（MPU）：可选，通过定义特权和非特权访问权限来保护存储器区域。 

#### 异常和中断：

​				异常--会改变程序流的事件，暂停当前任务，转而执行异常处理程序，ARM中中断是异常的一种，中断的异常处理即中断服务程序(ISR)。

​				Cortex-M异常源：不可屏蔽中断(NMI)、中断(IRQ)、SysTick、系统异常

​				嵌套向量中断控制器(NVIC)：可编程，寄存器位与系统控制空间(SCS)，处理异常和中断配置、优先级以及中断配置；特性--灵活的异常和中断管理、支持嵌套、向量化的异常/中断入口、中断屏蔽。

​				向量表：为系统存储器内的字数据数组，每个元素代表一个异常类型的起始地址，异常均在Thumb状态下执行，所以所有异常向量的最低为都应该为1。

​				错误处理：总线错误、使用错误及存储器管理错误，默认是禁止的，可单独使能。处理器检测到错误时， 触发错误异常，所有错误处理都会触发HardFault异常，HardFault总是使能的。

​				系统控制块(SCB)：位于NVIC中，包含寄存器，用于控制处理器配置（如低功耗模式）、提供错误状态信息、向量表重定位。

#### 调试：

​				调试接口--调试适配器连接到Cortex-M微控制器控制调试特性和访问片上的存储器空间

​				跟踪接口--用于运行时手机处理器的信息，如数据、实践、概况信息或者程序执行的完整细节

#### 复位和复位流程：

​				上电复位：复位微控制器中的所有部分，包括处理器、调试支持部件和外设等

​				系统复位：复位处理器和外设，不包括处理器的调试支持部件

​				处理器复位：只复位处理器。

​					复位-->(0x00000000)取MSP初始值，设置主栈-->(0X00000004)取复位向量-->(复位向量表示的地址)取第一条指令

#### 指令集：

​				格式如下：label（标号）表示地址位置，可选；mnemonic（助记符），指令的名称，后跟操作符

```c
label
    mnemonic operand1, iperand2, ... ; 注释
NVIC_IRQ_SETEN0 EQU 0XE00E100  //EQU 定义常量
LDR R0, =address1  ;//将寄存器address1中的字数据加载到寄存器R0中，若是程序地址LSB自动置一（thumb代码）
ADR R0, address1   ;//将程序代码的地址值加载到寄存器中
STR //将字数据存入寄存器中
MRS <Rn>, <SReg> //将特殊寄存器内容送到通用目的寄存器，读特殊寄存器
MSR <SReg>, <Rn> //写入特殊寄存器
B<cond> //条件跳转
   
```

#### 存储器系统：

​				简介：Cortex-M处理器可以对32位存储器进行寻址，存储空间可达2^32=4GB，多个总线接口，基于AMBA（高级微控制器总线架构）的总线接口设计；同时支持小端和大端的存储器系统；支持非对齐数据传输；支持排他传输；可位寻址的存储器空间（位段）；不同存储器区域的存储器属性和访问权限；可选的存储器保护单元。

​				存储器映射：代码区域--512MB，包括存储器第一部分默认的向量表； SRAM--512MB，支持位段（第一个MB）； 外设--512MB，第一个MB可位寻址； 外部RAM--两个512MB空间，用于片外存储器等其它RAM； 设备--两个512MB空间，用于片外外设等其它存储器； 系统--512MB，内部私有外设总线、外部私有外设总线及供应商定义区域。

​				连接处理器到存储器和外设：主要总线接口--AHB(AMBA高性能总线)Lite协议；code存储器区域独立于系统总线，数据访问和取指可同时进行，D-CODE总线访问，I-CODE总线取指及读向量表；私有外设总线--PPB不能用于外设总线

​				存储器的端：支持小端和大端，大多为小端(小字节在地址低端），在复位时确定存储器系统的端配置，复位前不会改变；取指总是处于小端模式，对SCS、调试部件和私有外设总线(PPB)区域访问总是小端的，可用REV、REVSH和ERV16等指令进行大小互换。

​				数据对齐和非对齐数据访问:存储器系统为32位，大小为32位（4字节，字）或16位（2字节，半字）可以对齐或非对齐；对齐传输指地址值为大小（字节为单位）的整数倍，字大小的对齐传输--4个字节对齐传输，访存时，传输地址隔4字节；栈操作、排他访问及位段操作不支持非对齐传输；非对齐传输时会拆分为多个对齐传输，会花费更多时钟周期；C编译在直接操作指针、_packed属性及内联/嵌入式汇编代码时可能出现非对齐传输，可设置配置控制寄存器中的UNALIGN_TRP（非对齐陷阱）位及系统控制块（SCB）中的CCR,使非对齐传输时触发异常。

##### 				位段操作：

​			简介--一次加载、存储操作可以访问（读/写）一个位，SRAM及外设区域的第一个1MB为位段区域，支持该操作；访问位段别名（位段操作）会引起对位段区域的访问；位段区域中每个字由位段别名地址区域32个字的LSB（第0位）表示，访问位段别名地址（额外32MB地址）时，该地址会被重映射到位段地址。

​			优势--每个任务的位访问是独立的，提高位操作速度（位段操作直接获得外设状态寄存器中的某位进行跳转）、实现从通用目的输入输出（GPIO)端口往串行设备的串行数据传输等。

##### 端模式

​		cortex-M3支持大端和小端模式，存储类型取决于微控制器设计的剩余部分（总线连接、外设等），多数情况下cortex-M3的微控制器都是小端，字数据的第一个字节存储在32位存储器位置的最低字节。

#### Cortex-M3设计综述

##### 		流水线

​		三级流水线，取值、指令译码和指令执行

##### 	总线接口

​		I-CODE总线：用于0x00000000~0x1FFFFFFF存储器区域的取指，取指操作均以字为单位，最多可同时取两条Thumb指令

​		D-CODE总线：用于0x00000000~0x1FFFFFFF存储器区域的数据访问，总线接口将非对齐转为对齐，总线上均是对齐传输

​		系统总线：用于0x20000000~0xDFFFFFFF存储器区域的取指和数据访问，总线上也都是对齐的。

​		外部PPB：用于0xE0040000~0xE00FFFFF存储器区域的私有外设访问，访问均是小端且对齐

​		DAP总线：用于连接调试接口模块，不能将该总线用于其他目的。

##### 复位类型和复位信号

​		上电复位：复位处理器内核、外设和调试系统

​		系统复位：复位整个系统，包括处理器内核及外设，调试系统不受影响

​		处理器复位：只复位处理器内核，但调试系统不受影响

​		JTAG复位：复位JTAG控制器

#### 异常

##### 异常类型

​		内置异常架构支持多个系统异常和外部中断，编号1~15的异常为系统异常，16以上为外部中断输入，1为复位异常优先级-3最高；2为NMI不可屏蔽中断优先级-2；1为硬件错误优先级-1，错误处理异常。

​		当前正在运行的异常编号可通过两个寄存器体现：中断程序状态寄存器(IPSR)、嵌套向量中断控制器(NVIC)中的中断装填寄存器(VECTACTIVE域)

##### 优先级定义

​		异常是否及何时执行受优先级制约，高优先级可抢占低优先级异常，除-3、-2、-1异常具有固定优先级，其它异常具有可编程的优先级

​		优先级组寄存器，高半部分为抢占优先级，低半部分为子优先级，高抢占优先级可抢占低抢占优先级，同抢占优先级，高子优先级异常先处理。

##### 向量表

​		处理器通过向量表中异常处理的起始地址去定位处理产生的异常，向量表默认位于存储器地址0处，向量地址为向量编号乘4。

​		重定位：可以设置NVIC中的向量表偏移寄存器进行向量表的重定位，地址偏移同向量表大小对齐，并需扩大为2的次方，再与4（每个向量4字节）相乘。

​		启动映像必须包括--主栈指针初始值、复位向量、NMI向量、硬件错误向量，启动完成后可以将向量表定义到新的位置，并重定位

##### 错误异常

​		总线错误--AHB接口传输过程中，错误响应会导致总线错误，有以下阶段会发生总线错误：压栈错误、出栈错误、中断流程时读取中断向量地址。

​		存储器管理错误--访问的存储器区域在MPU设置中未定义；写只读区域；用户态下访问只允许特权访问的区域。

​		使用错误--未定义的指令；非法中断返回；视图切换至ARM状态；

​		硬件错误--当使用、总线以及存储器错误无法执行时，引发硬件错误

##### 处理错误

​		软件开发中，使用FSR来确定程序中引起错误的原因并进行修正。

​		处理：复位；恢复；任务终止。

##### 请求管理调用和可挂起的服务调用

​		请求管理调用(SVC)和可挂起的服务调用(PendSV)为两个面向软件和操作系统的异常。

​		SVC用于产生系统功能调用，用户要使用特定硬件时，则通过SVC指令产生SVC异常，然后操作系统的异常处理便执行并且提供用户应用程序请求的服务。

​		PendSV在OS中一同使用，应用于上下文切换，SVC无法被挂起，PendSV可以被挂起。

流程：任务调用SVC用于任务切换-》OS收到请求，准备上下文切换，并挂起PendSV异常-》CPU退出SVC时，立即进入PendSV并执行上下文切换-》当PendSV完成后返回线程等级，并执行任务B-》中断产生并进入中断处理

#### 嵌套向量中断控制器和中断控制

##### 基本中断配置

​		相关寄存器：使能和清除使能寄存器；设置挂起和清除挂起寄存器；优先等级；活动状态；异常屏蔽寄存器：PRIMASK特殊寄存器用于禁止除NMI和硬件错误以外的所有异常，FAULMASK将当前的实际优先级修改为-1，可屏蔽硬件错误，可以将硬件错误异常的某些特性利用起来，BASEPRI特殊寄存器可以禁止低于某个等级的中断；

向量表偏移寄存器；STIR；优先级分组。

##### 软件中断

​		使用SETPEND寄存器，或使用STIR

```c
NVIC->STIR = 3;		//产生中断#3
```

#### SYSTICK定时器

​		systick定时器集成在NVIC中，并且可以产生SYSTICK异常（#15）
